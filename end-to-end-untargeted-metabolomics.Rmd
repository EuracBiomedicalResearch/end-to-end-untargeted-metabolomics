

# Introduction

# Data description

The data represents a subset of samples from a larger experiment and consists of
in total 10 mzML files with 3 samples from individuals with a cardiovascular
disease, 3 samples from healthy donors and 4 QC samples (pool of all samples of
the experiment). The MS data has been restricted to a retention time range from
20 to 230 seconds and an m/z range from 0 to 500. 

NEEEDS UPDATE!


# Data import


The *mzML* files with the raw MS data are located within the *data/mzML* folder
of this repository. [ideally, they should be added and then downloaded from
MassIVE].

```{r}
library(MsExperiment)
library(xcms)
library(RColorBrewer)
library(pander)
library(readxl)

#' read the sample descriptions from an xlsx sheet
pd <- as.data.frame(read_xlsx("data/phenodata.xlsx"))

#' Import the data

#' Massive data bank extraction but for now not. 
MZML_PATH <- "C:/Users/plouail/OneDrive - Scientific Network South Tyrol/end-to-end_worflow/data/mzML"

#' register(MulticoreParam(6)) ask johannes about that
data <- readMsExperiment(paste0(MZML_PATH, "/", pd$mzML_file) ,sampleData = pd)
data

```

- highlights the importance to have a phenodata table 

```{r phenodata, results = "asis"}
pandoc.table(pData(data), style = "rmarkdown",
             caption = "Samples from the data set.")
```

```{r define-colors}
col_phenotype <- brewer.pal(4, "Set1")[c(2, 1, 4)]
names(col_phenotype) <- c("CTR", "CVD", "QC")
```

## Set up parallel processing 
```{r}
#' Set up parallel processing using 2 cores
if (.Platform$OS.type == "unix") {
    register(bpstart(MulticoreParam(2)))
} else {
    register(bpstart(SnowParam(2)))
}
```

The experimental data is now an MsExperiment object 
- LC-MS data within that is stored as a spectra object within the MsExperiment object and can be accessed using Spectra() function 
  - Each element in this spectra object is a spectrum - they are organised linearly and are all combined in the same spectra object one after the other (through rt and samples)

- The MsExperiment object manages the linkage between samples and spectra 
  - it's lenght is defined by the number of samples within the object 
  
# General quality assessment

```{r bpc}
bpc <- chromatogram(data, aggregationFun = "max")
plot(bpc, col = paste0(col_sample, 80), lwd = 2)

fdata <- filterRt(data, c(10, 240))
bpc <- chromatogram(fdata, aggregationFun = "max")
plot(bpc, col = paste0(col_sample, 80), lwd = 2)
```

```{r}
plot(bpc, col = paste0(col_phenotype[bpc$phenotype], 80))
grid()
legend("topright", col = col_phenotype,
       legend = names(col_phenotype), lty = 1)
```

- BPC and heatmaps to evaluate LC performance.
- EIC of internal standards.

```{r}
bpcb <- bin(bpc)
plot(bpcb)

intmat <- do.call(cbind, lapply(bpcb, intensity))
heatmap(intmat)
```

# Data pre-processing

## Chromatographic peak detection

- run with the default settings, evaluate signal for e.g. serine.
- re-run with adapted settings.

## Retention time alignment

- use initial correspondence.
- use subset alignment.

## Correspondence

- use *bad* settings (check maybe xcmsTutorials for examples)

## Gap filling

- compare signal for filled-in and detected signal for QC samples. is it
  correlated?
  

# Data normalization

- between sample normalization
- maybe skip signal drift normalization
- Evaluation on IS.

# Identification of interesting features

- Pre-filtering.
- Differential abundance.

Task: sensitivity analysis: with/without normalization. with/without
pre-filtering.


# Annotation

- Different levels of annotation.
- Just m/z (mass).
- m/z and retention time.
- MS/MS spectra + public repository.
- MS/MS spectra + retention time.

# Summary

# Session information

# References

